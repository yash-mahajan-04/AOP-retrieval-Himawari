# Cloud-Free Satellite Data Extraction for Ground Stations

This Python script, `main_v3.py`, automates the process of extracting satellite data - specifically Top-of-Atmosphere (TOA) reflectance, brightness temperature, and viewing geometry - for pixels located near a predefined list of ground monitoring stations.

The script's primary function is to create clean, analysis-ready datasets by filtering out cloudy pixels. It is designed for efficiency by leveraging a pre-computed file of nearby pixel locations, avoiding redundant and time-consuming distance calculations for each satellite image.

---

## Key Features

-   **Efficient Lookup**: Uses a `precomputed_masks.pkl` file to instantly identify all satellite pixels near a ground station.
-   **Cloud-Screening ☁️**: For each satellite observation, it finds the corresponding cloud mask file and filters out all pixels identified as cloudy.
-   **Comprehensive Data Extraction**: Gathers TOA reflectance (Bands 1-6), brightness temperature (Bands 7-16), and key angular geometry (Solar Zenith, Viewing Zenith, Relative Azimuth).
-   **Batch Processing**: Automatically finds and processes all satellite NetCDF files in a specified folder.
-   **Skips Completed Work**: Checks if an output file for a given timestamp already exists and skips it to prevent re-processing.
-   **Organized Output**: Saves the extracted, cloud-free data into timestamped CSV files, one for each satellite observation time.

---

## Requirements

You will need Python 3 and the following libraries.

-   `xarray`
-   `numpy`
-   `pandas`

You can install them using pip:
```bash
pip install xarray numpy pandas
```
---

## Directory Structure and Inputs

This script requires a specific directory structure and three key inputs to function correctly. The script `main_v3.py` should be located inside the `TOA reflectance and Cloud` folder.
```
📁 Project_Root/
│
├── 📁 Pixels Close To Stations/
│   └── 📜 precomputed_masks.pkl   (INPUT 1: Generated by a separate script)
│
└── 📁 TOA reflectance and Cloud/
    │
    ├── 📜 main_v3.py              (THIS SCRIPT)
    │
    ├── 📁 Himawari Data/          (INPUT 2: Your satellite data .nc files)
    │   ├── NC_H08_YYYYMMDD_HHMM_...nc
    │   └── ...
    │
    ├── 📁 Cloud Mask Data/        (INPUT 3: Your cloud mask .nc files)
    │   ├── CLTYPE.H08_...YYYYMMDD_HHMM.nc
    │   └── ...
    │
    └── 📁 toa_filtered_near_stations/ (OUTPUT: Generated CSV files will appear here)
```

**Input Descriptions:**
1.  **`precomputed_masks.pkl`**: A file containing the pre-calculated indices and coordinates of all satellite pixels near each ground station.
2.  **`Himawari Data` Folder**: Contains the source satellite observation files in NetCDF format.
3.  **`Cloud Mask Data` Folder**: Contains the corresponding cloud classification files, also in NetCDF format. The script matches these to the Himawari data files by timestamp.

---

## How to Run

1.  **Verify Structure**: Ensure your folders and input files are arranged exactly as shown in the **Directory Structure** section.
2.  **Configure Paths (if needed)**: Open `main_v3.py` and check the folder paths in the "Settings" section to make sure they match your setup.
3.  **Execute the Script**: Navigate to the script's directory in your terminal and run it or you can directly run the pipeline from the main directory:
    ```bash
    # Make sure you are inside the 'TOA reflectance and Cloud' folder
    python main_v3.py

    # Or run below command from main directory
    python run_pipeline.py
    ```
The script will print its progress as it processes each file.

---

## Output Files ✅

The script will create a series of CSV files inside the `toa_filtered_near_stations` folder.

-   **Naming Convention**: `toa_filtered_YYYYMMDD_HHMM.csv` (e.g., `toa_filtered_20191202_0200.csv`).
-   **Contents**: Each file contains the combined, cloud-free data for all stations at a single point in time. If no station has any cloud-free pixels for that time, no file will be created.

The CSV files include the following columns:
-   `rho_01` to `rho_06`: Top-of-Atmosphere (TOA) reflectance for bands 1-6.
-   `bt_07` to `bt_16`: Brightness temperature (in Kelvin) for bands 7-16.
-   `SOZ`: Solar Zenith Angle.
-   `VZ`: Viewing Zenith Angle.
-   `RA`: Relative Azimuth Angle.
-   `latitude`, `longitude`: The precise coordinates of each cloud-free satellite pixel.
-   `Station`: The name of the nearest ground station.
-   `Date`, `Time`: The observation date and time.
