# Satellite and Ground Data Collocation Script

This Python script, `datetime_latlon_v5.py`, is the final step in a data processing pipeline, designed to collocate satellite observations with ground-based AERONET measurements. It finds temporal matches between the two datasets, aggregates the corresponding data, and produces a single, unified CSV file ready for machine learning or scientific analysis.

---

## Core Functionality

The script works by performing a "temporal collocation":

1.  **Loads Data**: It reads a master file containing all ground-based AERONET data and iterates through numerous CSV files, each containing cloud-free satellite pixel data for a specific time.
2.  **Time Matching**: For each satellite observation at a specific station, it searches the ground data for any measurements from the *same station* that were recorded within a predefined time window (e.g., +/- 30 minutes).
3.  **Data Aggregation**:
    * It averages all the satellite pixel values (reflectance, brightness temperature, etc.) near a station to create a single representative satellite data point.
    * It also averages all the ground-based AOD, AE, and FMF measurements found within the time window to create a single representative ground data point.
4.  **Combines and Saves**: The script combines the matched and averaged data points into a single row and saves all such matches into a final output file, `Final_Matched_Data.csv`.

---

## Requirements

You will need Python 3 and the following libraries:

-   `pandas`
-   `numpy`

You can install them using pip:
```bash
pip install pandas numpy
```

---

## Directory Structure and Inputs

The script requires a specific folder structure to locate its input files correctly.

```
📁 Project_Root/
│
├── 📁 Spatial Temporal Matching/
│   └── 📜 datetime_latlon_v5.py     (THIS SCRIPT)
│
├── 📁 toa_filtered_near_stations/     (INPUT 1: Satellite Data)
│   ├── toa_filtered_YYYYMMDD_HHMM.csv
│   └── ...
│
├── 📁 Aeronet Merging AOD FMF/
│   └── 📁 Merged Ground Truth/        (INPUT 2: Ground Data)
│       └── AERONET_groundtruth_ALL.csv
│
└── 📜 Final_Matched_Data.csv        (OUTPUT: Will be created in Project_Root)
```

**Input Descriptions:**
1.  **`toa_filtered_near_stations/`**: This folder must contain the CSV files generated by the previous step (`main_v3.py`), where each file holds cloud-free satellite data for one timestamp.
2.  **`AERONET_groundtruth_ALL.csv`**: This is a single, master CSV file containing the merged and cleaned ground-based AERONET measurements for all stations.

---

## How to Run

1.  **Verify Structure**: Ensure your folders and files are arranged exactly as shown above.
2.  **Check Filename**: Open `datetime_latlon_v5.py` and confirm that the `ground_data_filename` variable exactly matches the name of your ground data CSV file.
    ```python
    ground_data_filename = "AERONET_groundtruth_ALL.csv" # <--- CHECK THIS LINE
    ```
3.  **Execute the Script**: Important: You must run the script from the main `Project_Root` directory for the relative paths to work correctly or you can simpy run the pipeline.


    ```bash
    python datetime_latlon_v5.py
    ```
The script will print its progress and notify you upon completion.

---

## Output File Format ✅

The script generates a single file, **`Final_Matched_Data.csv`**, containing the collocated data. Each row represents a successful match between a satellite observation and one or more ground measurements.

| Column                | Description                                                                 |
|-----------------------|-----------------------------------------------------------------------------|
| `Datetime_sat`        | The timestamp of the satellite observation.                                 |
| `Station`             | The name of the ground station where the match occurred.                    |
| `rho_01` to `rho_06`  | **Averaged** Top-of-Atmosphere (TOA) reflectance for bands 1-6.             |
| `bt_07` to `bt_16`    | **Averaged** brightness temperature (in Kelvin) for bands 7-16.             |
| `SOZ`, `VZ`, `RA`     | **Averaged** Solar Zenith, Viewing Zenith, and Relative Azimuth angles.     |
| `latitude`, `longitude` | **Averaged** coordinates of the satellite pixels used in the match.         |
| `AOD_ground_mean`     | **Averaged** Aerosol Optical Depth from ground measurements.                |
| `AE_ground_mean`      | **Averaged** Angstrom Exponent from ground measurements.                    |
| `FMF_ground_mean`     | **Averaged** Fine Mode Fraction from ground measurements.                   |
| `num_ground_matches`  | The number of ground measurements that were averaged for the match.         |
